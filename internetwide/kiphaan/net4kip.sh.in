#!/bin/bash
#
# network4kiphaan.sh -- hook script for up/down operations
#
# For the proper hooks, see prestart and poststop in
# https://github.com/opencontainers/runtime-spec/blob/master/config.md
#
# A neat document explaining network namespaces is on
# https://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/
#
# From: Rick van Rein <rick@openfortress.nl>


#TODO# brctl addif/delif

case "$1" in

up)
	#TODO# ip netns add @KIP_NETNS@ &&
	ip link add @KIP_DMZ@0 type veth peer name @KIP_DMZ@ netns @KIP_NETNS@ &&
	ip link add @KIP_CTL@0 type veth peer name @KIP_CTL@ netns @KIP_NETNS@ &&
	ip netns exec @KIP_NETNS@ ip addr add 172.17.0.6/12 dev @KIP_DMZ@ &&  #TODO#
	ip link set dev @KIP_DMZ@0 up &&
	ip link set dev @KIP_CTL@0 up &&
	brctl addif @KIP_BRIDGE@  @KIP_DMZ@0 &&
	brctl addif @KIP_CONTROL@ @KIP_CTL@0 &&
	ip netns exec @KIP_NETNS@ ip link set dev @KIP_DMZ@ up &&
	ip netns exec @KIP_NETNS@ ip link set dev @KIP_CTL@ up &&
	ip netns exec @KIP_NETNS@ ip link set dev lo up
	;;

down)
	brctl delif @KIP_BRIDGE@  @KIP_DMZ@0
	brctl delif @KIP_CONTROL@ @KIP_CTL@0
	ip link del @KIP_DMZ@0
	ip link del @KIP_CTL@0
	#TODO# ip netns del @KIP_NETNS@
	;;

*)
	echo >&2 "Usage: $0 up|down"
	exit 1
	;;

esac
